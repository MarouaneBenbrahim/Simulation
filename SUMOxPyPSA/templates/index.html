<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUMO x PyPSA - Advanced Traffic & Power Grid Integration</title>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    
    <!-- Chart.js for power demand visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* Main Control Panel */
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 30, 40, 0.95));
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            min-width: 280px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-panel h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .status-indicator.offline {
            background: #f44336;
            animation: none;
        }
        
        /* Power Panel */
        .power-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 30, 40, 0.95));
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            min-width: 320px;
            max-width: 350px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .power-panel h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Grid Status Display */
        .grid-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .grid-status.normal {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .grid-status.stressed {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            animation: warning-pulse 2s infinite;
        }
        
        .grid-status.critical {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
            animation: critical-pulse 1s infinite;
        }
        
        .grid-status.blackout {
            background: linear-gradient(135deg, #212121, #000);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            animation: blackout-flicker 0.5s infinite;
        }
        
        @keyframes warning-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes critical-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes blackout-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Power Metrics */
        .power-metrics {
            margin-top: 15px;
        }
        
        .power-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .power-metric:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .power-metric-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .power-metric-value {
            font-weight: bold;
            font-size: 14px;
            color: #2196F3;
        }
        
        .power-metric-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .power-metric-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #00BCD4);
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        /* Statistics */
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .stat-value {
            font-weight: 600;
            color: #fff;
        }
        
        /* Buttons */
        .control-button {
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.4);
        }
        
        .control-button:active {
            transform: translateY(0);
        }
        
        .control-button:disabled {
            background: linear-gradient(135deg, #424242, #303030);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .control-button.stop {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
        
        .control-button.stop:hover {
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
        }
        
        /* Power Chart Container */
        .power-chart-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 30, 40, 0.95));
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            width: 500px;
            height: 250px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .power-chart-container h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 16px;
        }
        
        #powerChart {
            width: 100% !important;
            height: 180px !important;
        }
        
        /* Bidirectional Flow Indicator */
        .flow-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 30, 40, 0.95));
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .flow-indicator h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 16px;
            text-align: center;
        }
        
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin: 20px 0;
        }
        
        .flow-node {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .flow-arrow {
            flex: 1;
            height: 40px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .arrow-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #2196F3, transparent);
            animation: flow-right 2s linear infinite;
        }
        
        .arrow-line.reverse {
            background: linear-gradient(90deg, transparent, #f44336, transparent);
            animation: flow-left 2s linear infinite;
        }
        
        @keyframes flow-right {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes flow-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .flow-label {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            position: relative;
            z-index: 1;
        }
        
        /* Response Metrics */
        .response-metrics {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .response-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
        }
        
        .response-label {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .response-value {
            color: #2196F3;
            font-weight: 600;
        }
        
        /* Map Elements */
        .car-marker {
    width: 12px;
    height: 24px;
    background: #2196F3;
    border-radius: 3px;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.car-marker.ev {
    background: #4CAF50;
    width: 14px;
    height: 26px;
}

.car-marker:hover {
    transform: scale(1.2);
    z-index: 1000;
}
/* Better vehicle styling */
.vehicle-marker {
    transition: all 0.1s linear;
    z-index: 100;
}

.vehicle-icon {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    transition: transform 0.1s linear;
}

.vehicle-stopped .vehicle-icon {
    filter: drop-shadow(0 2px 4px rgba(255,0,0,0.5));
    animation: pulse-stop 1s infinite;
}

@keyframes pulse-stop {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.ev-vehicle {
    z-index: 150 !important;
}

/* Make traffic lights much more visible */
.traffic-light {
    width: 16px !important;
    height: 16px !important;
    border: 3px solid #222 !important;
    border-radius: 50%;
    z-index: 300 !important;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.traffic-light.red {
    background: radial-gradient(circle, #ff0000, #cc0000);
    box-shadow: 0 0 30px #ff0000, 0 0 60px #ff0000;
    animation: red-glow 1s ease-in-out infinite;
}

.traffic-light.yellow {
    background: radial-gradient(circle, #ffff00, #cccc00);
    box-shadow: 0 0 30px #ffff00, 0 0 60px #ffff00;
    animation: yellow-blink 0.5s ease-in-out infinite;
}

.traffic-light.green {
    background: radial-gradient(circle, #00ff00, #00cc00);
    box-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00;
}

@keyframes red-glow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

@keyframes yellow-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
        
        .traffic-light {
            width: 8px;
            height: 8px;
            border: 2px solid #333;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .traffic-light.red {
            background-color: #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }
        
        .traffic-light.yellow {
            background-color: #ffff00;
            box-shadow: 0 0 10px #ffff00;
        }
        
        .traffic-light.green {
            background-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .traffic-light.off {
            background-color: #666;
            animation: flashing 1s infinite;
        }
        
        @keyframes flashing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .charging-station-icon {
            width: 24px;
            height: 24px;
            background: #2196F3;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .charging-station-icon.available {
            background: #4CAF50;
        }
        
        .charging-station-icon.busy {
            background: #ff9800;
        }
        
        .charging-station-icon.full {
            background: #f44336;
        }
        
        /* Grid Zones */
        .grid-zone {
            fill-opacity: 0.15;
            stroke-width: 2;
            transition: all 0.3s ease;
        }
        
        .grid-zone.normal {
            fill: #4CAF50;
            stroke: #4CAF50;
        }
        
        .grid-zone.stressed {
            fill: #ff9800;
            stroke: #ff9800;
        }
        
        .grid-zone.critical {
            fill: #f44336;
            stroke: #f44336;
        }
        
        /* Transmission Lines */
        .transmission-line {
            stroke-width: 3;
            fill: none;
            opacity: 0.8;
        }
        
        .transmission-line.normal {
            stroke: #4CAF50;
        }
        
        .transmission-line.congested {
            stroke: #f44336;
            animation: congestion-pulse 1s infinite;
        }
        
        @keyframes congestion-pulse {
            0%, 100% { opacity: 0.8; stroke-width: 3; }
            50% { opacity: 1; stroke-width: 4; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Main Control Panel -->
    <div class="control-panel">
        <h3>
            <span class="status-indicator" id="connection-indicator"></span>
            Simulation Control
        </h3>
        
        <div class="stat-item">
            <span class="stat-label">Status:</span>
            <span class="stat-value" id="sim-status">Ready</span>
        </div>
        
        <div class="stat-item">
            <span class="stat-label">Time Step:</span>
            <span class="stat-value" id="time-step">0</span>
        </div>
        
        <div class="stat-item">
            <span class="stat-label">Vehicles:</span>
            <span class="stat-value" id="vehicle-count">0</span>
        </div>
        
        <div class="stat-item">
            <span class="stat-label">EVs:</span>
            <span class="stat-value" id="ev-count">0</span>
        </div>
        
        <div class="stat-item">
            <span class="stat-label">Traffic Lights:</span>
            <span class="stat-value" id="tl-count">0</span>
        </div>
        
        <button id="start-btn" class="control-button">Start Simulation</button>
        <button id="stop-btn" class="control-button stop" style="display: none;">Stop Simulation</button>
        <button id="restart-btn" class="control-button" style="display: none;">Restart</button>
    </div>
    
    <!-- Power Grid Panel -->
    <div class="power-panel">
        <h3>⚡ Power Grid Status</h3>
        
        <div id="grid-status" class="grid-status normal">
            GRID OPERATIONAL
        </div>
        
        <div class="power-metrics">
            <div class="power-metric">
                <span class="power-metric-label">Total Demand</span>
                <span class="power-metric-value" id="total-demand">0.00 MW</span>
                <div class="power-metric-bar">
                    <div class="power-metric-bar-fill" id="demand-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="power-metric">
                <span class="power-metric-label">Traffic Lights</span>
                <span class="power-metric-value" id="tl-demand">0.00 MW</span>
            </div>
            
            <div class="power-metric">
                <span class="power-metric-label">Street Lighting</span>
                <span class="power-metric-value" id="street-demand">0.00 MW</span>
            </div>
            
            <div class="power-metric">
                <span class="power-metric-label">EV Charging</span>
                <span class="power-metric-value" id="ev-demand">0.00 MW</span>
            </div>
            
            <div class="power-metric">
                <span class="power-metric-label">Grid Congestion</span>
                <span class="power-metric-value" id="grid-congestion">0.0%</span>
                <div class="power-metric-bar">
                    <div class="power-metric-bar-fill" id="congestion-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="power-metric">
                <span class="power-metric-label">Renewable Energy</span>
                <span class="power-metric-value" id="renewable-percent">0.0%</span>
                <div class="power-metric-bar">
                    <div class="power-metric-bar-fill" id="renewable-bar" style="width: 0%; background: linear-gradient(90deg, #4CAF50, #8BC34A);"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Power Demand Chart -->
    <div class="power-chart-container">
        <h4>Power Demand History</h4>
        <canvas id="powerChart"></canvas>
    </div>
    
    <!-- Bidirectional Flow Indicator -->
    <div class="flow-indicator">
        <h4>System Integration</h4>
        
        <div class="flow-diagram">
            <div class="flow-node">Traffic</div>
            <div class="flow-arrow">
                <div class="arrow-line" id="traffic-to-power"></div>
                <div class="flow-label">Demand</div>
            </div>
            <div class="flow-node">Grid</div>
            <div class="flow-arrow">
                <div class="arrow-line reverse" id="power-to-traffic"></div>
                <div class="flow-label">Response</div>
            </div>
            <div class="flow-node">Traffic</div>
        </div>
        
        <div class="response-metrics">
            <div class="response-item">
                <span class="response-label">Response Mode:</span>
                <span class="response-value" id="response-mode">Normal</span>
            </div>
            <div class="response-item">
                <span class="response-label">Affected Lights:</span>
                <span class="response-value" id="affected-lights">0</span>
            </div>
            <div class="response-item">
                <span class="response-label">EV Charging:</span>
                <span class="response-value" id="ev-limit">Unlimited</span>
            </div>
            <div class="response-item">
                <span class="response-label">Light Dimming:</span>
                <span class="response-value" id="light-dimming">100%</span>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize map centered on Los Angeles
        const map = L.map('map').setView([34.0522, -118.2437], 13);
        
        // Bright standard map tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 20
        }).addTo(map);
                
        // Connect to server
        const socket = io();
        
        // Storage for map elements
        const vehicleMarkers = {};
        const trafficLightMarkers = {};
        const chargingStationMarkers = {};
        const gridZones = {};
        const transmissionLines = {};
        
        // Simulation state
        let simulationRunning = false;
        let currentCity = 'losangeles';
        
        // UI Elements
        const connectionIndicator = document.getElementById('connection-indicator');
        const simStatus = document.getElementById('sim-status');
        const timeStep = document.getElementById('time-step');
        const vehicleCount = document.getElementById('vehicle-count');
        const evCount = document.getElementById('ev-count');
        const tlCount = document.getElementById('tl-count');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const restartBtn = document.getElementById('restart-btn');
        
        // Power UI Elements
        const gridStatus = document.getElementById('grid-status');
        const totalDemand = document.getElementById('total-demand');
        const tlDemand = document.getElementById('tl-demand');
        const streetDemand = document.getElementById('street-demand');
        const evDemand = document.getElementById('ev-demand');
        const gridCongestion = document.getElementById('grid-congestion');
        const renewablePercent = document.getElementById('renewable-percent');
        const responseMode = document.getElementById('response-mode');
        const affectedLights = document.getElementById('affected-lights');
        const evLimit = document.getElementById('ev-limit');
        const lightDimming = document.getElementById('light-dimming');
        
        // Power demand chart
        const ctx = document.getElementById('powerChart').getContext('2d');
        const powerChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Total Demand',
                        data: [],
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        borderWidth: 2
                    },
                    {
                        label: 'EV Charging',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        borderWidth: 2
                    },
                    {
                        label: 'Infrastructure',
                        data: [],
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: '#fff',
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Power (MW)',
                            color: '#fff'
                        },
                        ticks: {
                            color: '#fff'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time Steps',
                            color: '#fff'
                        },
                        ticks: {
                            color: '#fff'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
        
        // Socket event handlers
        socket.on('connect', () => {
            console.log('Connected to server');
            connectionIndicator.classList.remove('offline');
            simStatus.textContent = 'Connected';
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            connectionIndicator.classList.add('offline');
            simStatus.textContent = 'Disconnected';
        });
        
        socket.on('simulation_started', (data) => {
            simulationRunning = true;
            simStatus.textContent = 'Running';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            restartBtn.style.display = 'block';
        });
        
        socket.on('simulation_stopped', (data) => {
            simulationRunning = false;
            simStatus.textContent = 'Stopped';
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
        });
        
        socket.on('grid_state_change', (data) => {
            console.log('Grid state changed:', data);
            // Visual notification of state change
            showNotification(`Grid state changed: ${data.new_state}`);
        });
        
        socket.on('update', (data) => {
            updateSimulation(data);
        });
        
        // Button handlers
        startBtn.addEventListener('click', () => {
            socket.emit('start_simulation', { city: currentCity });
        });
        
        stopBtn.addEventListener('click', () => {
            socket.emit('stop_simulation');
        });
        
        restartBtn.addEventListener('click', () => {
            clearMap();
            socket.emit('restart_simulation', { city: currentCity });
        });
        
        // Update simulation data
        function updateSimulation(data) {
            // Update statistics
            if (data.stats) {
                timeStep.textContent = data.stats.step || 0;
                vehicleCount.textContent = data.stats.vehicles || 0;
                evCount.textContent = data.stats.ev_count || 0;
                tlCount.textContent = data.stats.traffic_lights || 0;
            }
            
            // Update vehicles
            if (data.vehicles) {
                updateVehicles(data.vehicles);
            }
            
            // Update traffic lights
            if (data.traffic_lights) {
                updateTrafficLights(data.traffic_lights);
            }
            
            // Update power data
            if (data.power) {
                updatePowerSystem(data.power);
            }
        }
        
        // Update vehicle markers
        function updateVehicles(vehicles) {
    const activeVehicleIds = new Set(vehicles.map(v => v.id));
    
    // Remove vehicles that left the region or despawned
    for (const id in vehicleMarkers) {
        if (!activeVehicleIds.has(id)) {
            map.removeLayer(vehicleMarkers[id]);
            delete vehicleMarkers[id];
        }
    }
    
    // Update or create vehicles
    vehicles.forEach(vehicle => {
        const isNew = !vehicleMarkers[vehicle.id];
        
        if (isNew) {
            // Create larger vehicle marker with better visibility
            let iconHtml = '';
            let iconClass = 'vehicle-marker';
            
            if (vehicle.is_ev) {
                // Green car for EV
                iconHtml = `<div class="vehicle-icon ev" style="transform: rotate(${vehicle.angle - 90}deg);">
                    <svg width="30" height="40" viewBox="0 0 30 40">
                        <rect x="5" y="5" width="20" height="30" rx="3" fill="#4CAF50"/>
                        <rect x="8" y="8" width="14" height="8" fill="#81C784"/>
                        <rect x="8" y="25" width="14" height="6" fill="#81C784"/>
                        <circle cx="10" cy="35" r="2" fill="#333"/>
                        <circle cx="20" cy="35" r="2" fill="#333"/>
                    </svg>
                </div>`;
                iconClass += ' ev-vehicle';
            } else {
                // Blue car for normal
                iconHtml = `<div class="vehicle-icon" style="transform: rotate(${vehicle.angle - 90}deg);">
                    <svg width="30" height="40" viewBox="0 0 30 40">
                        <rect x="5" y="5" width="20" height="30" rx="3" fill="#2196F3"/>
                        <rect x="8" y="8" width="14" height="8" fill="#64B5F6"/>
                        <rect x="8" y="25" width="14" height="6" fill="#64B5F6"/>
                        <circle cx="10" cy="35" r="2" fill="#333"/>
                        <circle cx="20" cy="35" r="2" fill="#333"/>
                    </svg>
                </div>`;
            }
            
            // Add stopped indicator
            if (vehicle.is_waiting || vehicle.at_light) {
                iconClass += ' vehicle-stopped';
            }
            
            const carIcon = L.divIcon({
                html: iconHtml,
                className: iconClass,
                iconSize: [30, 40],  // Bigger size
                iconAnchor: [15, 20]  // Center anchor
            });
            
            vehicleMarkers[vehicle.id] = L.marker([vehicle.y, vehicle.x], {
                icon: carIcon,
                zIndexOffset: vehicle.is_ev ? 100 : 0
            }).addTo(map);
            
            // Add detailed popup
            vehicleMarkers[vehicle.id].bindPopup(`
                <b>Vehicle: ${vehicle.id}</b><br>
                Type: ${vehicle.is_ev ? '⚡ Electric' : '⛽ Normal'}<br>
                Speed: ${vehicle.speed.toFixed(1)} m/s<br>
                ${vehicle.at_light ? '🚦 At traffic light' : ''}
                ${vehicle.is_waiting ? '⏸️ Waiting' : '▶️ Moving'}
            `);
        } else {
            // Update existing vehicle
            const marker = vehicleMarkers[vehicle.id];
            const currentPos = marker.getLatLng();
            const newPos = L.latLng(vehicle.y, vehicle.x);
            
            // Smooth movement
            marker.setLatLng(newPos);
            
            // Update rotation and stopped state
            let iconHtml = '';
            let iconClass = 'vehicle-marker';
            
            if (vehicle.is_ev) {
                iconHtml = `<div class="vehicle-icon ev" style="transform: rotate(${vehicle.angle - 90}deg);">
                    <svg width="30" height="40" viewBox="0 0 30 40">
                        <rect x="5" y="5" width="20" height="30" rx="3" fill="${vehicle.is_waiting ? '#2E7D32' : '#4CAF50'}"/>
                        <rect x="8" y="8" width="14" height="8" fill="#81C784"/>
                        <rect x="8" y="25" width="14" height="6" fill="#81C784"/>
                        <circle cx="10" cy="35" r="2" fill="#333"/>
                        <circle cx="20" cy="35" r="2" fill="#333"/>
                    </svg>
                </div>`;
                iconClass += ' ev-vehicle';
            } else {
                iconHtml = `<div class="vehicle-icon" style="transform: rotate(${vehicle.angle - 90}deg);">
                    <svg width="30" height="40" viewBox="0 0 30 40">
                        <rect x="5" y="5" width="20" height="30" rx="3" fill="${vehicle.is_waiting ? '#1565C0' : '#2196F3'}"/>
                        <rect x="8" y="8" width="14" height="8" fill="#64B5F6"/>
                        <rect x="8" y="25" width="14" height="6" fill="#64B5F6"/>
                        <circle cx="10" cy="35" r="2" fill="#333"/>
                        <circle cx="20" cy="35" r="2" fill="#333"/>
                    </svg>
                </div>`;
            }
            
            if (vehicle.is_waiting || vehicle.at_light) {
                iconClass += ' vehicle-stopped';
            }
            
            marker.setIcon(L.divIcon({
                html: iconHtml,
                className: iconClass,
                iconSize: [30, 40],
                iconAnchor: [15, 20]
            }));
        }
    });
}
        
        // Update traffic light markers
        function updateTrafficLights(trafficLights) {
            trafficLights.forEach(tl => {
                const color = getTrafficLightColor(tl.state);
                
                if (!trafficLightMarkers[tl.id]) {
                    const tlIcon = L.divIcon({
                        className: `traffic-light ${color}`,
                        iconSize: [8, 8],
                        iconAnchor: [4, 4]
                    });
                    
                    trafficLightMarkers[tl.id] = L.marker([tl.y, tl.x], {
                        icon: tlIcon
                    }).addTo(map);
                } else {
                    // Update color
                    trafficLightMarkers[tl.id].setIcon(L.divIcon({
                        className: `traffic-light ${color}`,
                        iconSize: [8, 8],
                        iconAnchor: [4, 4]
                    }));
                }
            });
        }
        
        // Get traffic light color from state
        function getTrafficLightColor(state) {
            if (!state) return 'off';
            const lower = state.toLowerCase();
            if (lower.includes('g')) return 'green';
            if (lower.includes('y')) return 'yellow';
            if (lower.includes('r')) return 'red';
            return 'off';
        }
        
        // Update power system visualization
        function updatePowerSystem(powerData) {
            // Update grid state
            if (powerData.grid) {
                const state = powerData.grid.state || 'normal';
                gridStatus.className = `grid-status ${state}`;
                gridStatus.textContent = `GRID ${state.toUpperCase()}`;
                
                // Update zones
                if (powerData.grid.zones) {
                    updateGridZones(powerData.grid.zones);
                }
                
                // Update transmission lines
                if (powerData.grid.transmission_lines) {
                    updateTransmissionLines(powerData.grid.transmission_lines);
                }
            }
            
            // Update metrics
            if (powerData.metrics) {
                const m = powerData.metrics;
                
                totalDemand.textContent = `${(m.total_demand || 0).toFixed(2)} MW`;
                tlDemand.textContent = `${(m.traffic_lights || 0).toFixed(3)} MW`;
                streetDemand.textContent = `${(m.street_lights || 0).toFixed(3)} MW`;
                evDemand.textContent = `${(m.ev_charging || 0).toFixed(3)} MW`;
                
                const congestion = m.grid_congestion || 0;
                gridCongestion.textContent = `${congestion.toFixed(1)}%`;
                document.getElementById('congestion-bar').style.width = `${Math.min(100, congestion)}%`;
                
                const renewable = m.renewable_percentage || 0;
                renewablePercent.textContent = `${renewable.toFixed(1)}%`;
                document.getElementById('renewable-bar').style.width = `${renewable}%`;
                
                // Update demand bar
                const maxDemand = 1000; // MW
                const demandPercent = (m.total_demand / maxDemand) * 100;
                document.getElementById('demand-bar').style.width = `${Math.min(100, demandPercent)}%`;
            }
            
            // Update charging stations
            if (powerData.charging_stations) {
                updateChargingStations(powerData.charging_stations);
            }
            
            // Update chart
            if (powerData.metrics) {
                updatePowerChart(powerData.metrics);
            }
        }
        
        // Update grid zones visualization
        function updateGridZones(zones) {
            zones.forEach(zone => {
                const zoneId = `zone_${zone.name}`;
                
                if (!gridZones[zoneId]) {
                    const bounds = L.latLngBounds(
                        [zone.bounds[0][0], zone.bounds[0][1]],
                        [zone.bounds[1][0], zone.bounds[1][1]]
                    );
                    
                    gridZones[zoneId] = L.rectangle(bounds, {
                        color: zone.status === 'normal' ? '#4CAF50' : '#f44336',
                        weight: 2,
                        fillOpacity: 0.15,
                        className: `grid-zone ${zone.status}`
                    }).addTo(map);
                    
                    gridZones[zoneId].bindPopup(`
                        <b>${zone.name} Power Zone</b><br>
                        Load: ${zone.load.toFixed(1)} MW<br>
                        Capacity: ${zone.capacity} MW<br>
                        Utilization: ${(zone.utilization * 100).toFixed(1)}%
                    `);
                } else {
                    // Update zone status
                    gridZones[zoneId].setStyle({
                        color: zone.status === 'normal' ? '#4CAF50' : '#f44336',
                        className: `grid-zone ${zone.status}`
                    });
                }
            });
        }
        
        // Update transmission lines
        function updateTransmissionLines(lines) {
            lines.forEach(line => {
                const lineId = line.id;
                
                if (!transmissionLines[lineId]) {
                    // Create line (simplified - would need actual coordinates)
                    // This is a placeholder - real implementation would need bus coordinates
                } else {
                    // Update line status
                }
            });
        }
        
        // Update charging stations
        function updateChargingStations(stations) {
            stations.forEach(station => {
                if (!chargingStationMarkers[station.id]) {
                    const icon = L.divIcon({
                        className: `charging-station-icon ${station.status}`,
                        html: '⚡',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    chargingStationMarkers[station.id] = L.marker(
                        [station.position[0], station.position[1]],
                        { icon: icon }
                    ).addTo(map);
                    
                    chargingStationMarkers[station.id].bindPopup(`
                        <b>EV Charging Station</b><br>
                        Type: ${station.type}<br>
                        Vehicles: ${station.vehicles_charging}/${station.capacity}<br>
                        Power: ${station.power_consumption.toFixed(1)} kW
                    `);
                } else {
                    // Update icon based on status
                    chargingStationMarkers[station.id].setIcon(L.divIcon({
                        className: `charging-station-icon ${station.status}`,
                        html: '⚡',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    }));
                }
            });
        }
        
        // Update power chart
        function updatePowerChart(metrics) {
            // Keep only last 50 points
            if (powerChart.data.labels.length > 50) {
                powerChart.data.labels.shift();
                powerChart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }
            
            powerChart.data.labels.push(timeStep.textContent);
            powerChart.data.datasets[0].data.push(metrics.total_demand || 0);
            powerChart.data.datasets[1].data.push(metrics.ev_charging || 0);
            powerChart.data.datasets[2].data.push(
                (metrics.traffic_lights || 0) + (metrics.street_lights || 0)
            );
            
            powerChart.update('none'); // Update without animation
        }
        
        // Clear all map elements
        function clearMap() {
            // Clear vehicles
            for (const id in vehicleMarkers) {
                vehicleMarkers[id].remove();
            }
            Object.keys(vehicleMarkers).forEach(key => delete vehicleMarkers[key]);
            
            // Clear traffic lights
            for (const id in trafficLightMarkers) {
                trafficLightMarkers[id].remove();
            }
            Object.keys(trafficLightMarkers).forEach(key => delete trafficLightMarkers[key]);
            
            // Clear charging stations
            for (const id in chargingStationMarkers) {
                chargingStationMarkers[id].remove();
            }
            Object.keys(chargingStationMarkers).forEach(key => delete chargingStationMarkers[key]);
            
            // Clear grid zones
            for (const id in gridZones) {
                gridZones[id].remove();
            }
            Object.keys(gridZones).forEach(key => delete gridZones[key]);
            
            // Clear chart
            powerChart.data.labels = [];
            powerChart.data.datasets.forEach(dataset => {
                dataset.data = [];
            });
            powerChart.update();
        }
        
        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(33, 150, 243, 0.95);
                color: white;
                padding: 20px 30px;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { opacity: 0; transform: translate(-50%, -60%); }
                to { opacity: 1; transform: translate(-50%, -50%); }
            }
            @keyframes slideOut {
                from { opacity: 1; transform: translate(-50%, -50%); }
                to { opacity: 0; transform: translate(-50%, -40%); }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize
        console.log('SUMO x PyPSA Interface Initialized');
        simStatus.textContent = 'Ready';
    </script>
</body>
</html>